<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.25">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" type="image/png" href="elogo.png">
  <link rel="icon" type="image/png" href="elogo.png">
  <link rel="stylesheet" title="base" href="style.css?%VERSION%" type="text/css">
  <link rel="stylesheet" title="base" href="settings.css?%VERSION%" type="text/css">
  <title>Radio - Ustawienia</title>
  <style>
    /* Inline CSS to prevent overlap in status-location */
    .inputwrap.status-location {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-top: 12px; /* Spacing below Użyj mojej lokalizacji button */
      padding: 8px 0; /* Padding for visual separation */
    }
    .inputwrap.status-location .inputtitle {
      margin-bottom: 10px; /* Space between label and message */
      font-size: 14px; /* Consistent font size */
      font-weight: 500; /* Slightly bold for clarity */
      color: #333; /* Adjust based on theme, if needed */
    }
    .inputwrap.status-location .inputinfo {
      padding: 0; /* Remove padding to avoid overlap */
      font-size: 12px; /* Smaller font for message */
      line-height: 1.4; /* Improved readability */
      color: #555; /* Slightly lighter for distinction, adjust as needed */
      max-width: 100%; /* Prevent overflow */
      word-wrap: break-word; /* Ensure long text wraps */
    }
    /* Ensure flex-row doesn't cause layout issues */
    .flex-row.status-row {
      margin-top: 10px; /* Extra spacing for the row */
      display: block; /* Override flex if it causes issues */
    }
  </style>
</head>
<body>
  <div class="content">
    <h2 class="pagetitle">USTAWIENIA</h2>
    <div class="navigation group group_system hidden" id="navigation">
      <div class="navitem group group_system hidden" data-target="group_system">system</div>
      <div class="navitem group group_display group_nextion hidden" data-target="group_display">ekran</div>
      <div class="navitem group group_controls hidden" data-target="group_controls">sterowanie</div>
      <div class="navitem group group_timezone hidden" data-target="group_timezone">strefa czasowa</div>
      <div class="navitem group group_wifi hidden" data-target="group_wifi">Wi-Fi</div>
      <div class="navitem group group_weather hidden" data-target="group_weather">Pogoda</div>
    </div>

    <div class="playerwrap">
      <div class="settingsirwrap" id="settingscontent"><a name="system"></a>

        <!-- SYSTEM -->
        <section class="group group_system hidden" id="group_system">
          <div class="title"><span>system</span></div><div class="reset" data-name="system"></div>
          <div class="flex-row">
            <div class="checkbox off nous" id="smartstart">Inteligentny Start</div>
            <div class="checkbox off nous" id="audioinfo">Informacje o dźwięku</div>
            <div class="checkbox off nous group group_vu hidden" id="vumeter">Wskaźnik VU</div>
          </div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">opóźnienie restartu AP (min)</span>
              <span class="inputinfo" id="slsoftapinfo">0</span>
              <input type="range" id="slsoftap" class="slider" data-slaveid="slsoftapinfo" name="softap" min="0" max="20" value="0">
            </div>
          </div>
          <div class="flex-row" id="mdnsnamerow">
            <div class="inputwrap">
              <span class="inputtitle">nazwa mDNS</span>
              <input type="text" id="mdnsname" class="textinput inputchange" name="mdnsname" value="" maxlength="24" />
            </div>
            <div class="button apply hlbutton" data-name="rebootmdns" style="margin-top: 24px;">zapisz</div>
          </div>
          <div class="row-title"><span>aktualizacja</span></div>
          <div class="flex-row last">
            <div class="button apply" data-name="fwupdate" id="fwupdate">Oprogramowanie</div>
            <div class="button apply" data-name="webboard" id="webboard">Płyta</div>
          </div>
        </section><a name="screen"></a>

        <!-- DISPLAY -->
        <section class="group group_display group_oled group_nextion hidden" id="group_display">
          <div class="title"><span>ekran</span></div><div class="reset" data-name="screen"></div>
          <div class="flex-row">
            <div class="checkbox off nous group group_tft hidden" id="flipscreen">Odwróć ekran</div>
            <div class="checkbox off nous group group_tft hidden" id="invertdisplay">Odwróć kolory</div>
            <div class="checkbox on nous group group_brightness group_oled hidden" id="screenon">Włącz</div>
          </div>
          <div class="flex-row group group_tft group_oled group_nextion hidden">
            <div class="checkbox off nous" id="numplaylist">Numerowana lista odtwarzania</div>
          </div>
          <div class="flex-row group group_brightness hidden">
            <div class="inputwrap">
              <span class="inputtitle">jasność</span>
              <span class="inputinfo" id="slbrightnessinfo">0</span>
              <input type="range" id="slbrightness" class="slider" data-slaveid="slbrightnessinfo" name="brightness" min="0" max="100" value="100">
            </div>
          </div>
          <div class="flex-row group group_nokia hidden">
            <div class="inputwrap">
              <span class="inputtitle">kontrast</span>
              <span class="inputinfo" id="slcontrastinfo">0</span>
              <input type="range" id="slcontrast" class="slider" data-slaveid="slcontrastinfo" name="contrast" min="0" max="100" value="55">
            </div>
          </div>
          <div class="row-title"><span>wygaszacz ekranu</span></div>
          <div class="flex-row group group_tft group_oled group_nextion hidden" style="margin-top:20px;">
            <div class="inputwrap">
              <span class="inputtitle">podczas zatrzymania</span>
              <div class="checkbox off nous" id="screensaverenabled" style="padding-top:16px;"></div>
            </div>
            <div class="inputwrap">
              <span class="inputtitle">pusty ekran</span>
              <div class="checkbox off nous" id="screensaverblank" style="padding-top:16px;"></div>
            </div>
            <div class="inputwrap">
              <span class="inputtitle">czas (sek)</span>
              <input type="number" id="screensavertimeout" class="textinput inputchange" name="screensavertimeout" value="" maxlength="3" min="5" max="65520" />
            </div>
          </div>
          <div class="flex-row group group_tft group_oled group_nextion hidden">
            <div class="inputwrap">
              <span class="inputtitle">podczas odtwarzania</span>
              <div class="checkbox off nous" id="screensaverplayingenabled" style="padding-top:16px;"></div>
            </div>
            <div class="inputwrap">
              <span class="inputtitle">pusty ekran</span>
              <div class="checkbox off nous" id="screensaverplayingblank" style="padding-top:16px;"></div>
            </div>
            <div class="inputwrap">
              <span class="inputtitle">czas (sek)</span>
              <input type="number" id="screensaverplayingtimeout" class="textinput inputchange" name="screensaverplayingtimeout" value="" maxlength="3" min="10" max="65520" />
            </div>
          </div>
        </section>

        <!-- CONTROLS -->
        <section class="group group_controls hidden" id="group_controls">
          <div class="title"><span>Sterowanie</span></div><div class="reset" data-name="controls"></div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">kroki głośności</span>
              <span class="inputinfo" id="slvolstepsinfo">0</span>
              <input type="range" id="slvolsteps" class="slider" data-slaveid="slvolstepsinfo" name="volsteps" min="1" max="10" value="1">
            </div>
          </div>
          <div class="flex-row group group_touch hidden">
            <div class="checkbox off nous" id="fliptouch">Odwróć dotyk</div>
            <div class="checkbox off nous" id="dbgtouch">Debuguj dotyk</div>
          </div>
          <div class="flex-row group group_encoder hidden">
            <div class="inputwrap">
              <span class="inputtitle">przyspieszenie enkodera</span>
              <span class="inputinfo" id="slencaccelerationinfo">0</span>
              <input type="range" id="slencacceleration" class="slider" data-slaveid="slencaccelerationinfo" name="encacceleration" min="0" max="700" value="200">
            </div>
          </div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">przełączanie stacji jednym kliknięciem</span>
              <div class="checkbox off nous" id="oneclickswitching" style="padding-top:6px;"></div>
            </div>
          </div>
          <div class="flex-row group group_ir hidden">
            <div class="inputwrap">
              <span class="inputtitle">tolerancja IR [<a href="https://crankyoldgit.github.io/IRremoteESP8266/doxygen/html/" target="_blank">dokumentacja</a>]</span>
              <span class="inputinfo" id="slirtlpinfo">0</span>
              <input type="range" id="slirtlp" class="slider" data-slaveid="slirtlpinfo" name="irtlp" min="10" max="80" value="0">
            </div>
          </div>
          <div class="flex-row group group_ir last hidden">
            <div class="button apply" data-name="setupir">Rekorder IR</div>
          </div>
        </section><a name="timezone"></a>

        <!-- TIMEZONE -->
        <section class="group group_timezone hidden" id="group_timezone">
          <div class="title"><span>strefa czasowa</span></div><div class="reset" data-name="timezone"></div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">godziny</span>
              <input type="number" id="tzhour" class="textinput" name="tzhour" value="" maxlength="3" min="-12" max="14" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">minuty</span>
              <input type="number" id="tzmin" class="textinput" name="tzmin" value="" maxlength="2" min="0" max="45" step="15" />
            </div>
          </div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">serwer NTP #1</span>
              <input type="text" id="sntp1" class="textinput" name="sntp1" value="" maxlength="34" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">serwer NTP #2</span>
              <input type="text" id="sntp2" class="textinput" name="sntp2" value="" maxlength="34" />
            </div>
          </div>
          <div class="flex-row last">
            <div class="button apply hlbutton" data-name="applytz" id="applytz">Zastosuj</div>
          </div>
        </section><a name="wifi"></a>

        <!-- WIFI -->
        <section class="group group_wifi hidden" id="group_wifi">
          <div class="title"><span>Wi-Fi</span></div>
          <div class="flex-row credential">
            <div class="inputwrap">
              <span class="inputtitle">nazwa sieci</span>
              <input type="text" id="ssid0" class="textinput" name="ssid" value="" maxlength="30" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">hasło</span>
              <input type="text" id="pass0" class="textinput" name="pass" value="" placeholder="**********" maxlength="40" autocomplete="off" readonly="readonly" data-pass="" onfocus="this.removeAttribute('readonly');" />
            </div>
          </div>
          <div class="flex-row credential">
            <div class="inputwrap">
              <span class="inputtitle">nazwa sieci</span>
              <input type="text" id="ssid1" class="textinput" name="ssid" maxlength="30" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">hasło</span>
              <input type="text" id="pass1" class="textinput" name="pass" value="" placeholder="**********" maxlength="40" autocomplete="off" readonly="readonly" data-pass="" onfocus="this.removeAttribute('readonly');" />
            </div>
          </div>
          <div class="flex-row credential">
            <div class="inputwrap">
              <span class="inputtitle">nazwa sieci</span>
              <input type="text" id="ssid2" class="textinput" name="ssid" value="" maxlength="30" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">hasło</span>
              <input type="text" id="pass2" class="textinput" name="pass" value="" placeholder="**********" maxlength="40" autocomplete="off" readonly="readonly" data-pass="" onfocus="this.removeAttribute('readonly');" />
            </div>
          </div>
          <div class="flex-row credential">
            <div class="inputwrap">
              <span class="inputtitle">nazwa sieci</span>
              <input type="text" id="ssid3" class="textinput" name="ssid" value="" maxlength="30" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">hasło</span>
              <input type="text" id="pass3" class="textinput" name="pass" value="" placeholder="**********" maxlength="40" autocomplete="off" readonly="readonly" data-pass="" onfocus="this.removeAttribute('readonly');" />
            </div>
          </div>
          <div class="flex-row credential">
            <div class="inputwrap">
              <span class="inputtitle">nazwa sieci</span>
              <input type="text" id="ssid4" class="textinput" name="ssid" value="" maxlength="30" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">hasło</span>
              <input type="text" id="pass4" class="textinput" name="pass" value="" placeholder="**********" maxlength="40" autocomplete="off" readonly="readonly" data-pass="" onfocus="this.removeAttribute('readonly');" />
            </div>
          </div>
          <div class="flex-row last">
            <input id="file-upload" type="file" accept=".txt, .csv" hidden/>
            <div class="button group group_system hidden" data-name="wifiexport">Eksportuj</div>
            <div class="button hlbutton" data-name="wifiupload">Zapisz i reset</div>
          </div>
        </section><a name="weather"></a>

        <!-- WEATHER -->
        <section class="group group_weather hidden" id="group_weather">
          <div class="title"><span>Pogoda</span></div><div class="reset" data-name="weather"></div>
          <div class="flex-row center">
            <div class="checkbox off nous" id="showweather">pokaż pogodę</div>
          </div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">szerokość geograficzna</span>
              <input type="number" id="weatherlat" class="textinput" name="weatherlat" value="" min="-90" max="90" step="0.000001" autocomplete="off" />
            </div>
            <div class="inputwrap">
              <span class="inputtitle">długość geograficzna</span>
              <input type="number" id="weatherlon" class="textinput" name="weatherlon" value="" min="-180" max="180" step="0.000001" autocomplete="off" />
            </div>
          </div>
          <div class="flex-row">
            <div class="button apply hlbutton" id="btnGeo">Użyj mojej lokalizacji</div>
          </div>
          <div class="flex-row status-row">
            <div class="inputwrap status-location">
              <span class="inputtitle">status lokalizacji</span>
              <div id="geomsg" class="inputinfo"></div>
            </div>
          </div>
          <div class="flex-row">
            <div class="inputwrap">
              <span class="inputtitle">klucz API OpenWeatherMap [<a href="https://home.openweathermap.org/users/sign_in" target="_blank">link</a>]</span>
              <input type="text" id="weatherkey" class="textinput" name="weatherkey" value="" />
            </div>
          </div>
          <div class="flex-row last">
            <div class="button apply hlbutton" data-name="applyweather">Zastosuj</div>
          </div>
        </section>

        <a name="controls"></a>
        <div class="hr">&nbsp;</div>
      </div>
    </div><!--playerwrap-->

    <div class="button apply done group group_system hidden" data-name="settingsdone" id="settingsdone">gotowe</div>
    <div id="copy">napędzane przez <a target="_blank" href="https://www.facebook.com/groups/1431695504639752">Seba99317</a> | v%VERSION%</div>
  </div>

  <!-- oryginalny skrypt interfejsu -->
  <script src="script.js?%VERSION%"></script>

  <!-- geolokalizacja + fallback IP (działa także na HTTP) -->
  <script>
  (function () {
    function setMsg(text) {
      var el = document.getElementById('geomsg');
      if (el) el.textContent = text || '';
    }

    function setLatLon(lat, lon) {
      var latEl = document.getElementById('weatherlat');
      var lonEl = document.getElementById('weatherlon');
      if (latEl && lonEl) {
        latEl.value = Number(lat).toFixed(6);
        lonEl.value = Number(lon).toFixed(6);
      }
    }

    async function ipFallback() {
      setMsg('Pobieram lokalizację po IP…');
      try {
        // 1. ipapi.co
        var r = await fetch('https://ipapi.co/json/');
        if (!r.ok) throw new Error('ipapi.co HTTP ' + r.status);
        var j = await r.json();
        if (typeof j.latitude === 'number' && typeof j.longitude === 'number') {
          setLatLon(j.latitude, j.longitude);
          setMsg('Użyto lokalizacji po IP. Dokładność przybliżona.');
          return true;
        }
        throw new Error('Brak współrzędnych w odpowiedzi ipapi.co');
      } catch (_) {
        try {
          // 2. ipwho.is
          var r2 = await fetch('https://ipwho.is/');
          if (!r2.ok) throw new Error('ipwho.is HTTP ' + r2.status);
          var j2 = await r2.json();
          if (j2 && j2.success && j2.latitude != null && j2.longitude != null) {
            setLatLon(j2.latitude, j2.longitude);
            setMsg('Użyto lokalizacji po IP. Dokładność przybliżona.');
            return true;
          }
          throw new Error('Brak współrzędnych w odpowiedzi ipwho.is');
        } catch (e2) {
          setMsg('Nie udało się pobrać lokalizacji (IP fallback).');
          return false;
        }
      }
    }

    async function autoFillGPS() {
      setMsg('Pobieram lokalizację…');

      if (!('geolocation' in navigator)) {
        setMsg('Brak wsparcia geolokalizacji – użyję lokalizacji po IP.');
        await ipFallback();
        return;
      }

      if (!window.isSecureContext) {
        // Na HTTP (ESP32) większość przeglądarek blokuje navigator.geolocation.
        setMsg('Geolokalizacja wymaga HTTPS – użyję lokalizacji po IP.');
        await ipFallback();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          setLatLon(pos.coords.latitude, pos.coords.longitude);
          setMsg('Współrzędne pobrane z urządzenia.');
        },
        async function (err) {
          setMsg('Błąd geolokalizacji: ' + err.message + ' – użyję lokalizacji po IP.');
          await ipFallback();
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
      );
    }

    // Upubliczniamy funkcję jeśli chcesz wywoływać ją z HTML
    window.autoFillGPS = autoFillGPS;

    document.addEventListener('DOMContentLoaded', function () {
      var b = document.getElementById('btnGeo');
      if (b) b.addEventListener('click', autoFillGPS);
      // Możesz automatycznie spróbować pobrać lokalizację przy starcie sekcji:
      // autoFillGPS();
    });
  })();
  </script>
</body>
</html>